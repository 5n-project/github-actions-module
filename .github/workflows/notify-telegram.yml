name: Reusable Notify

on:
  workflow_call:
    inputs:
      event_kind:
        description: "push | pr | merge"
        required: true
        type: string
    secrets:
      TELEGRAM_TOKEN:        { required: true }
      TELEGRAM_TO:           { required: true }   # Í∏∞Î≥∏ Î∞©
      TELEGRAM_TO_PUSH:      { required: false }  # ÏÑ†ÌÉù
      TELEGRAM_TO_PR:        { required: false }  # ÏÑ†ÌÉù
      TELEGRAM_TO_MERGE:     { required: false }  # ÏÑ†ÌÉù

jobs:
  format_and_send:
    runs-on: ubuntu-latest
    steps:
      # ÏΩúÎü¨(ÎèÑÎ©îÏù∏) Î†àÌè¨Ïùò git ÌûàÏä§ÌÜ†Î¶¨Î•º ÏïàÏ†ÑÌïòÍ≤å ÏÇ¨Ïö©
      - name: Checkout caller repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.sha }}
          fetch-depth: 0

      - name: Build unified message from caller context
        id: msg
        shell: bash
        run: |
          set -euo pipefail
          
          REPO="${{ github.repository }}"
          ACTOR="${{ github.actor }}"
          REF="${{ github.ref_name }}"
          RUN_URL="https://github.com/${REPO}/actions/runs/${{ github.run_id }}"
          EVENT="${{ inputs.event_kind }}"

          # Ïª§Î∞ã Ï†ïÎ≥¥
          SHA_SHORT="$(git rev-parse --short=8 HEAD || true)"
          COMMIT_MSG="$(git log -1 --pretty=%s || true)"
          COMMITS_URL="https://github.com/${REPO}/commits/${REF}"

          if [[ "$EVENT" == "push" ]]; then
            TITLE="${COMMIT_MSG:-${{ github.event.head_commit.message || '' }}}"
            MSG="üîî * PUSH to ${REF} *
                Repo: ${REPO}
                By: ${ACTOR}
                Commit: \`${SHA_SHORT}\`
                Message: ${TITLE}
              
                üßæ [Recent Commits] ${COMMITS_URL}
                ‚ñ∂Ô∏è [Workflow Run] ${RUN_URL}"
  
          elif [[ "$EVENT" == "pr" ]]; then
          PR_NUM="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_USER="${{ github.event.pull_request.user.login }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          BASE="${{ github.event.pull_request.base.ref }}"
          HEAD="${{ github.event.pull_request.head.ref }}"
          MSG="üß© * PR to ${BASE} *
              Repo: ${REPO}
              PR: #${PR_NUM} - ${PR_TITLE}
              From: ${HEAD} ‚Üí ${BASE}
              By: ${PR_USER}
                
              üßæ [PR] ${PR_URL}
              ‚ñ∂Ô∏è [Workflow Run] ${RUN_URL}"
  
          else
          PR_NUM="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          MERGER="${ACTOR}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          BASE="${{ github.event.pull_request.base.ref }}"
          HEAD="${{ github.event.pull_request.head.ref }}"
          MSG="‚úÖ * MERGED into ${BASE} *
              Repo: ${REPO}
              PR: #${PR_NUM} - ${PR_TITLE}
              From: ${HEAD} ‚Üí ${BASE}
              Merged By: ${MERGER}
              
              üßæ [PR] ${PR_URL}
              ‚ñ∂Ô∏è [Workflow Run] ${RUN_URL}"
          fi
        
          {
            echo "text<<EOF"
            echo "${MSG}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Decide chat target by event_kind
        id: route
        shell: bash
        run: |
          EVENT="${{ inputs.event_kind }}"
          TO_DEFAULT="${{ secrets.TELEGRAM_TO }}"
          TO_PUSH="${{ secrets.TELEGRAM_TO_PUSH }}"
          TO_PR="${{ secrets.TELEGRAM_TO_PR }}"
          TO_MERGE="${{ secrets.TELEGRAM_TO_MERGE }}"
      
          case "$EVENT" in
            push)  TO="${TO_PUSH:-$TO_DEFAULT}" ;;
            pr)    TO="${TO_PR:-$TO_DEFAULT}" ;;
            merge) TO="${TO_MERGE:-$TO_DEFAULT}" ;;
            *)     TO="$TO_DEFAULT" ;;
          esac
      
          echo "to=$TO" >> "$GITHUB_OUTPUT"

      - name: Send Telegram
        uses: 5n-project/github-actions-module/actions/notify-telegram@v1
        with:
          bot_token: ${{ secrets.TELEGRAM_TOKEN }}
          chat_id: ${{ steps.route.outputs.to }}
          message: ${{ steps.msg.outputs.text }}
