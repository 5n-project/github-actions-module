name: Reusable Notify

on:
  workflow_call:
    inputs:
      event_kind:
        description: "push | pr | merge | deploy"
        required: true
        type: string
      project:
        description: "project/service name (deploy Ï†ÑÏÜ°Ïö©)"
        required: false
        type: string
      environment:
        description: "environment (dev|stg|prod Îì±, deploy Ï†ÑÏÜ°Ïö©)"
        required: false
        type: string
      result:
        description: "deploy result (success|failure, deploy Ï†ÑÏÜ°Ïö©)"
        required: false
        type: string

jobs:
  format_and_send:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout caller repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.sha }}
          fetch-depth: 0

      - name: Build unified message
        id: msg
        shell: bash
        run: |
          set -euo pipefail

          REPO="${{ github.repository }}"
          ACTOR="${{ github.actor }}"
          REF="${{ github.ref_name }}"
          RUN_URL="https://github.com/${REPO}/actions/runs/${{ github.run_id }}"
          EVENT="${{ inputs.event_kind }}"

          # Ïª§Î∞ã Ï†ïÎ≥¥ (ÏóÜÏñ¥ÎèÑ Ïã§Ìå®ÌïòÏßÄ ÏïäÎèÑÎ°ù)
          COMMIT_MSG="$(git log -1 --pretty=%s 2>/dev/null || true)"
          COMMITS_URL="https://github.com/${REPO}/commits/${REF}"

          case "$EVENT" in
            deploy)
              PROJECT="${{ inputs.project }}"
              ENVNAME="${{ inputs.environment }}"
              RESULT="${{ inputs.result }}"
              IMAGE="${{ inputs.image }}"
              TAG="${{ inputs.tag }}"

              if [[ "${RESULT:-}" == "success" ]]; then
                ICON="‚úÖ"; RESULT_UPPER="SUCCESS"
              else
                ICON="‚ùå"; RESULT_UPPER="FAILED"
              fi

              MSG="${ICON} *DEPLOY ${RESULT_UPPER}*
              Project: ${PROJECT}
              Env:     ${ENVNAME}"
                [[ -n "${TAG:-}"   ]] && MSG="${MSG}
              Tag:     ${TAG}"
                [[ -n "${IMAGE:-}" ]] && MSG="${MSG}
              Image:   ${IMAGE}"
                MSG="${MSG}
              
              ‚ñ∂Ô∏è Workflow Run: ${RUN_URL}"
            ;;
                
            push)
              # head_commit.messageÍ∞Ä ÏóÜÏùÑ ÏàòÎèÑ ÏûàÏúºÎãà COMMIT_MSGÎ°ú ÎåÄÏ≤¥
              TITLE="${COMMIT_MSG}"
              MSG="üîî *PUSH to ${REF}*
              Repo: ${REPO}
              By: ${ACTOR}
              Message: ${TITLE}
              
              ‚ñ∂Ô∏è Recent Commits: ${COMMITS_URL}
              ‚ñ∂Ô∏è Workflow Run: ${RUN_URL}"
            ;;

            pr)
              PR_NUM="${{ github.event.pull_request.number }}"
              PR_TITLE="${{ github.event.pull_request.title }}"
              PR_USER="${{ github.event.pull_request.user.login }}"
              PR_URL="${{ github.event.pull_request.html_url }}"
              BASE="${{ github.event.pull_request.base.ref }}"
              HEAD="${{ github.event.pull_request.head.ref }}"
          
              MSG="üß© *PR to ${BASE}*
              Repo: ${REPO}
              PR: #${PR_NUM} - ${PR_TITLE}
              From: ${HEAD} ‚Üí ${BASE}
              By: ${PR_USER}
              
              ‚ñ∂Ô∏è PR: ${PR_URL}
              ‚ñ∂Ô∏è Workflow Run: ${RUN_URL}"
            ;;
  
            merge)
              PR_NUM="${{ github.event.pull_request.number }}"
              PR_TITLE="${{ github.event.pull_request.title }}"
              MERGER="${ACTOR}"
              PR_URL="${{ github.event.pull_request.html_url }}"
              BASE="${{ github.event.pull_request.base.ref }}"
              HEAD="${{ github.event.pull_request.head.ref }}"
          
              MSG="‚úÖ *MERGED into ${BASE}*
              Repo: ${REPO}
              PR: #${PR_NUM} - ${PR_TITLE}
              From: ${HEAD} ‚Üí ${BASE}
              Merged By: ${MERGER}
              
              ‚ñ∂Ô∏è PR: ${PR_URL}
              ‚ñ∂Ô∏è Workflow Run: ${RUN_URL}"
              ;;
                
              *)
                MSG="‚ÑπÔ∏è Unsupported event_kind: ${EVENT}
                Repo: ${REPO}
                ‚ñ∂Ô∏è Workflow Run: ${RUN_URL}"
              ;;
          
              esac  
              {
                printf 'text<<EOF\n'
                printf '%s\n' "$MSG"
                printf 'EOF\n'
              } >> "$GITHUB_OUTPUT"
                   
      - name: Decide chat target by event_kind
        id: route
        shell: bash
        run: |
          set -euo pipefail
          EVENT="${{ inputs.event_kind }}"
          TO_DEFAULT="${{ secrets.TELEGRAM_TO }}"
          case "$EVENT" in
          push)   TO="${{ secrets.TELEGRAM_TO_PUSH }}"   ;;
          pr)     TO="${{ secrets.TELEGRAM_TO_PR }}"     ;;
          merge)  TO="${{ secrets.TELEGRAM_TO_MERGE }}"  ;;
          deploy) TO="${{ secrets.TELEGRAM_TO_DEPLOY }}" ;;
          *)      TO="" ;;
          
          esac
          [[ -z "${TO:-}" ]] && TO="$TO_DEFAULT"
          echo "to=$TO" >> "$GITHUB_OUTPUT"

      - name: Send Telegram
        uses: 5n-project/github-actions-module/actions/notify-telegram@v1
        with:
          bot_token: ${{ secrets.TELEGRAM_TOKEN }}
          chat_id: ${{ steps.route.outputs.to }}
          message: ${{ steps.msg.outputs.text }}
